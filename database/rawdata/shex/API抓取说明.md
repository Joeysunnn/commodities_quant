# API直接抓取使用说明

## 快速开始

### 默认测试（10-11月数据）
```bash
python grab_api.py
```

### 自定义时间范围
```bash
# 格式：python grab_api.py 开始日期 结束日期 [输出文件]
python grab_api.py 2025-01-01 2025-12-31
python grab_api.py 2025-10-01 2025-11-30 my_data.csv
```

## 功能特点

✅ **无需手动下载HTML** - 直接通过API获取数据  
✅ **速度快** - 每个请求1-2秒，不使用Selenium  
✅ **自动兼容两种API** - 智能切换新旧格式  
✅ **自动去重** - 不会重复保存相同日期的数据  
✅ **累积保存** - 新数据自动追加到现有CSV  

## API格式说明

### 旧格式（2025年10月31日之前）
```
URL: https://www.shfe.com.cn/data/tradedata/future/weeklydata/YYYYMMDDweeklystock.dat
返回: JSON格式（目前解析待完善）
```

### 新格式（2025年10月31日之后）
```
URL: https://www.shfe.com.cn/data/tradedata/future/stockdata/weeklystock_YYYYMMDD/ZH/all.html
返回: HTML格式
```

## 测试结果

**2025年10-11月测试：**
- 成功抓取：5个周五（10/31, 11/7, 11/14, 11/21, 11/28）
- 失败：4个（10月31日之前的旧格式API待完善）
- 速度：约10秒完成5个日期

## 使用示例

### 示例1：抓取全年数据
```bash
python grab_api.py 2025-01-01 2025-12-31
```

### 示例2：只抓取特定月份
```bash
python grab_api.py 2025-11-01 2025-11-30
```

### 示例3：查看帮助
```python
# 在Python中
from grab_api import SHFEAPIFetcher
fetcher = SHFEAPIFetcher()
results = fetcher.fetch_data_range('2025-11-01', '2025-11-30')
fetcher.save_to_csv(results, 'november_data.csv')
```

## 数据格式

CSV文件包含27列：
- 日期（YYYYMMDD）
- 保税商品总计（9个指标）
- 完税商品总计（9个指标）
- 总计（9个指标）

## 已知问题

1. **旧API格式（10月31日之前）** - `.dat`文件的JSON结构需要进一步分析，目前返回数据但解析失败
2. **部分日期无数据** - 如果当周没有交易或数据未发布，会返回404

## 下一步改进

- [ ] 完善旧API（.dat格式）的JSON解析
- [ ] 添加进度条显示
- [ ] 支持多线程并发抓取
- [ ] 添加重试机制
- [ ] 支持代理配置

## 对比其他方案

| 方案 | 速度 | 稳定性 | 自动化程度 |
|------|------|--------|-----------|
| 手动HTML | 最快（1秒） | 高 | 低（需手动） |
| Selenium | 慢（15-20秒/次） | 中 | 高 |
| **API直接抓取** | **快（1-2秒/次）** | **高** | **高** |

## 成功案例

```
默认测试模式：抓取2025年10月-11月的数据
============================================================
时间范围: 2025-10-01 至 2025-11-30
找到 9 个周五

抓取完成: 成功 5 个, 失败 4 个
新增记录: 5
总记录数: 6
```

## 推荐使用

🎯 **强烈推荐**使用此方案，因为：
1. 速度快（比Selenium快10倍）
2. 无需浏览器环境
3. 代码简洁，易于维护
4. 完全自动化，可定时运行
